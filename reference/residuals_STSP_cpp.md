# Residuals of a statespace system

This internal helper function computes the residuals (and the
directional derivatives of the residuals) for a statespace system of the
form \$\$a\_{t+1} = A a_t + B u_t, \\ y_t = C a_t + D u_t\$\$ The system
must be square and non-empty, i.e. \\m=n\>0\\.

## Usage

``` r
residuals_STSP_cpp(A, B, C, D, y, a, u, dPI, dU)
```

## Arguments

- A:

  \\(s,s)\\ matrix.

- B:

  \\(s,m)\\ matrix.

- C:

  \\(m,s)\\ matrix.

- D:

  \\(m,m)\\ matrix, must be regular.

- y:

  \\(m,N)\\ matrix with the outputs: \\(y_1,y_2,\ldots,y_N)\\.

- a:

  \\(s,N+1)\\ matrix. This matrix is overwritten with the (computed)
  states: \\(a_1,a_2,\ldots,a_N,a\_{N+1})\\. On input `a[,1]` must hold
  the initial state \\a_1\\.

- u:

  \\(m,N)\\ matrix. This matrix is overwritten with (computed)
  residuals: \\(u_1,u_2,\ldots,u_N)\\.

- dPI:

  \\((m+s)^2,K)\\ matrix.

- dU:

  \\(mN,K)\\ matrix or \\(0,0)\\ matrix. This matrix is overwritten with
  the directional derivatives of the residuals. However, if the matrix
  is empty then no derivatives are computed.

## Value

This RcppArmadillo implementation returns `NULL` but **overwrites** the
input arguments `a`, `u` and `dU`!

## Note

Use this procedure with care!

- The procedure does **not** check the input arguments.

- The procedure **overwrites** the input arguments `a`, `u` and `dU`.

- The data matrices are organized columnwise (to avoid memory
  shuffling)!

## See also

[`outputs_ARMA_cpp`](https://bfunovits.github.io/RLDM/reference/outputs_ARMA_cpp.md),
[`residuals_ARMA_cpp`](https://bfunovits.github.io/RLDM/reference/residuals_ARMA_cpp.md),
[`cll_theta_ARMA_cpp`](https://bfunovits.github.io/RLDM/reference/cll_theta_ARMA_cpp.md),
[`outputs_STSP_cpp`](https://bfunovits.github.io/RLDM/reference/outputs_STSP_cpp.md),
`residuals_STSP_cpp`,
[`cll_theta_STSP_cpp`](https://bfunovits.github.io/RLDM/reference/cll_theta_STSP_cpp.md)
and
[`solve_de`](https://bfunovits.github.io/RLDM/reference/solve_de.md),
[`solve_inverse_de`](https://bfunovits.github.io/RLDM/reference/solve_de.md)
and [`ll`](https://bfunovits.github.io/RLDM/reference/ll.md).

## Examples

``` r
# generate a random statespace model (3 outputs, 3 inputs and 4 states)
m = 2
s = 3
model = test_stspmod(dim = c(m, m), s = s, digits = 2)

# generate random noise sequence (sample size N = 10)
n.obs = 10
u = matrix(rnorm(n.obs*m), nrow = m, ncol = n.obs)

# generate matrix for the state sequence
a = matrix(0, nrow = s, ncol = n.obs+1)
a[,1] = rnorm(s) # random initial state a[1]

# generate matrix for the outputs
y = matrix(0, nrow = m, ncol = n.obs)

# compute outputs and states
outputs_STSP_cpp(model$sys$A, model$sys$B, model$sys$C, model$sys$D, u, a, y)

# recompute the states and disturbances/residuals from the given outputs:
uu = u + 0 # "deep copy" of the disturbances
aa = a + 0 # and the states
aa[, 2:(n.obs+1)] = 0 # clear all states a[t], t > 1
residuals_STSP_cpp(model$sys$A, model$sys$B, model$sys$C, model$sys$D,
                   y, aa, uu, diag(0), diag(0))
all.equal(u, uu) # check
#> [1] TRUE
all.equal(a, aa) # check
#> [1] TRUE

# compute directional derivatives of residuals
dPI = diag((m+s)^2)
dU = matrix(0, nrow = n.obs*m, ncol = ncol(dPI))
residuals_STSP_cpp(model$sys$A, model$sys$B, model$sys$C, model$sys$D,
                   y, aa, uu, dPI, dU)

# check the directional derivatives
eps = 1e-8
dU_num = matrix(0, nrow = m*n.obs, ncol = (m+s)^2)
dPI = matrix(0, nrow = (m+s), ncol = (m+s))
for (k in (1:((m+s)^2))) {
  dPI[] = 0
  dPI[k] = eps
  uu = u + 0 # "deep copy" of the disturbances
  aa = a + 0 # and the states
  residuals_STSP_cpp(model$sys$A + dPI[1:s,1:s],
                     model$sys$B + dPI[1:s,(s+1):(s+m)],
                     model$sys$C + dPI[(s+1):(s+m),1:s],
                     model$sys$D + dPI[(s+1):(s+m),(s+1):(s+m)],
                     y, aa, uu, diag(0), diag(0))
  dU_num[, k] = c(uu - u )/eps  # num. approx. of the derivative in direction "dPI"
}
# relative error of the numerical approximation
junk = (abs(dU)+abs(dU_num))
junk[junk == 0] = 1
2*abs(dU_num - dU)/junk
#>               [,1]         [,2]         [,3]         [,4]         [,5]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 3.539123e-11 0.000000e+00
#>  [2,] 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 3.539123e-11
#>  [3,] 9.271545e-08 1.475098e-08 2.170907e-07 1.108795e-07 9.080888e-09
#>  [4,] 1.222304e-06 4.254935e-08 1.295921e-07 8.160470e-08 5.821469e-08
#>  [5,] 3.580341e-07 1.394300e-07 1.130386e-07 2.328873e-07 2.771399e-07
#>  [6,] 1.520322e-06 2.569418e-09 8.779160e-08 6.356559e-08 1.415965e-07
#>  [7,] 1.485957e-07 3.158238e-07 2.668712e-07 5.540776e-10 5.333695e-08
#>  [8,] 4.814363e-07 4.438798e-08 1.524144e-07 1.154069e-07 7.112715e-08
#>  [9,] 1.051356e-07 6.948119e-08 2.958370e-07 2.473956e-08 1.603950e-07
#> [10,] 2.865098e-08 2.678232e-07 1.892716e-07 7.129843e-07 5.105203e-08
#> [11,] 3.304802e-07 2.234660e-07 1.446996e-07 2.282665e-08 2.810666e-08
#> [12,] 9.712362e-07 1.075640e-07 3.722035e-06 9.948874e-09 1.132505e-07
#> [13,] 1.009672e-07 4.824878e-07 6.600101e-08 9.771811e-09 8.105989e-08
#> [14,] 3.164795e-07 1.912975e-06 9.621592e-07 2.354486e-06 3.611797e-08
#> [15,] 3.930023e-07 1.092518e-07 3.954097e-07 2.798584e-07 1.457090e-09
#> [16,] 5.741859e-07 4.761899e-07 1.834419e-06 7.070846e-07 8.253886e-07
#> [17,] 1.027980e-06 2.677483e-05 2.531114e-07 1.810991e-07 9.607898e-07
#> [18,] 3.743842e-06 1.574752e-07 3.047850e-08 3.956977e-07 9.220477e-08
#> [19,] 2.713116e-08 6.359518e-07 2.438524e-06 4.635316e-07 1.530584e-07
#> [20,] 1.662677e-06 6.111871e-07 8.140541e-07 7.344509e-07 1.129148e-06
#>               [,6]         [,7]         [,8]         [,9]        [,10]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 1.866027e-08 0.000000e+00
#>  [2,] 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.921910e-08
#>  [3,] 4.814591e-08 3.101647e-08 1.984627e-07 9.228377e-09 2.344545e-08
#>  [4,] 1.136101e-06 3.002408e-08 1.265440e-07 2.959716e-08 4.569787e-08
#>  [5,] 1.507067e-07 8.339649e-08 7.333008e-08 1.969406e-08 5.093333e-08
#>  [6,] 9.250020e-08 1.884521e-08 4.584914e-09 5.481872e-09 9.722425e-09
#>  [7,] 7.434066e-09 2.942299e-09 4.403511e-09 9.052865e-09 3.448199e-08
#>  [8,] 4.470846e-07 1.791174e-08 2.469904e-08 5.918884e-09 3.906170e-08
#>  [9,] 1.169560e-09 8.591558e-08 1.086511e-08 8.822512e-09 2.517854e-08
#> [10,] 1.046609e-07 3.427066e-08 1.098287e-08 9.808491e-09 3.608004e-08
#> [11,] 5.133852e-08 8.654159e-08 5.139415e-08 2.949290e-08 3.218333e-08
#> [12,] 1.854763e-08 3.935641e-08 9.045052e-09 1.702129e-08 1.220973e-08
#> [13,] 3.135439e-08 3.938882e-08 7.474015e-08 6.514208e-09 3.278134e-08
#> [14,] 2.511903e-07 9.311619e-09 1.984626e-08 2.505397e-08 7.876682e-08
#> [15,] 1.466685e-08 8.590687e-08 5.137938e-08 1.299977e-08 2.454514e-08
#> [16,] 3.350457e-07 1.720098e-10 3.298758e-08 1.037292e-08 2.285369e-08
#> [17,] 2.443962e-08 2.019015e-08 5.146781e-08 8.969537e-09 5.421068e-08
#> [18,] 5.297140e-08 2.996221e-08 1.338090e-08 3.250788e-08 1.199714e-08
#> [19,] 2.017288e-08 2.253046e-08 2.637356e-08 9.574674e-09 1.033680e-08
#> [20,] 2.830408e-07 3.184994e-08 5.999948e-08 5.271886e-08 3.798645e-08
#>              [,11]        [,12]        [,13]        [,14]        [,15]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 1.804277e-08 0.000000e+00
#>  [2,] 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.804277e-08
#>  [3,] 8.897281e-08 1.049453e-07 1.247306e-08 1.219940e-07 6.254397e-08
#>  [4,] 2.496383e-06 8.503293e-08 1.809113e-07 6.889618e-08 1.319117e-06
#>  [5,] 8.366543e-07 1.007178e-06 1.606254e-07 1.101220e-06 3.111178e-05
#>  [6,] 1.104504e-06 8.382899e-08 8.603361e-08 1.694161e-07 4.183553e-07
#>  [7,] 6.745299e-07 2.338120e-07 3.980898e-07 2.023761e-08 6.761233e-08
#>  [8,] 1.145941e-06 3.753377e-07 3.409140e-07 4.253644e-07 9.469227e-08
#>  [9,] 1.029409e-07 5.063525e-08 4.228585e-07 2.616068e-08 7.987357e-08
#> [10,] 1.264637e-06 4.617074e-08 2.685786e-07 5.774424e-08 2.490763e-08
#> [11,] 2.885239e-07 1.249883e-07 2.302225e-07 4.586764e-07 3.651409e-08
#> [12,] 1.184225e-06 3.154263e-08 1.524328e-07 2.863893e-08 1.242265e-06
#> [13,] 7.025556e-07 6.162769e-07 1.140161e-07 6.886399e-08 1.920368e-07
#> [14,] 9.188629e-07 4.188185e-09 2.784730e-07 2.083320e-07 1.616494e-07
#> [15,] 2.087436e-07 3.847606e-08 2.142563e-07 4.529135e-08 9.664082e-08
#> [16,] 6.389605e-07 9.009719e-08 2.707680e-07 2.858368e-07 9.542442e-07
#> [17,] 1.002654e-06 1.973819e-06 3.452643e-07 1.541856e-07 4.393807e-07
#> [18,] 4.531135e-07 1.148982e-07 2.189085e-07 2.666217e-08 3.616405e-08
#> [19,] 2.959542e-07 9.496835e-08 2.509351e-07 2.208704e-07 9.632206e-08
#> [20,] 1.551630e-06 3.076706e-07 6.749534e-07 3.945037e-07 5.152125e-07
#>              [,16]        [,17]        [,18]        [,19]        [,20]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 1.852913e-08 0.000000e+00
#>  [2,] 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 2.034849e-09
#>  [3,] 7.484641e-08 9.127449e-09 1.672122e-07 2.882179e-08 8.745737e-09
#>  [4,] 1.978964e-06 4.320591e-08 1.753598e-07 1.041411e-07 1.868496e-07
#>  [5,] 4.932044e-07 1.320882e-06 9.772636e-08 2.778196e-07 4.158722e-07
#>  [6,] 1.835297e-06 4.445854e-08 3.619274e-08 7.497472e-08 9.876125e-08
#>  [7,] 2.850728e-08 1.141324e-07 3.594570e-10 5.290737e-08 6.236537e-08
#>  [8,] 3.123198e-07 2.519447e-07 1.492429e-07 4.103750e-07 1.145940e-06
#>  [9,] 4.581291e-07 2.115134e-07 8.784805e-05 4.124625e-08 4.286420e-08
#> [10,] 1.433182e-07 6.717882e-05 2.628002e-07 1.415223e-06 7.267614e-07
#> [11,] 7.147772e-06 1.861006e-06 6.612250e-07 7.869246e-07 9.033520e-06
#> [12,] 4.356749e-06 1.051435e-06 7.223923e-06 2.717371e-07 9.275316e-07
#> [13,] 6.904849e-07 2.295236e-08 1.762178e-06 5.331568e-07 1.893998e-07
#> [14,] 2.050053e-08 6.615831e-07 2.163386e-06 3.987112e-07 1.567312e-07
#> [15,] 2.018946e-06 4.923921e-07 5.318629e-08 2.275570e-06 1.061980e-06
#> [16,] 2.737082e-06 2.385166e-06 2.253986e-06 1.393739e-06 3.883465e-07
#> [17,] 3.220067e-07 7.688024e-07 2.824648e-06 8.014961e-06 3.382005e-06
#> [18,] 1.211786e-05 2.889050e-05 1.834763e-06 9.555796e-06 1.435613e-06
#> [19,] 4.279066e-07 1.362312e-06 4.238437e-06 4.850393e-06 2.165238e-06
#> [20,] 1.438408e-04 3.156808e-06 4.704458e-05 1.429157e-05 1.670327e-04
#>              [,21]        [,22]        [,23]        [,24]        [,25]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 6.756948e-09 0.000000e+00
#>  [2,] 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 4.274011e-08
#>  [3,] 5.253348e-08 1.819712e-08 3.518909e-07 1.382927e-08 3.395437e-08
#>  [4,] 2.512061e-06 6.520936e-08 2.295098e-07 3.481519e-08 2.570054e-09
#>  [5,] 7.721357e-07 4.724670e-07 5.745153e-08 5.997662e-08 8.945064e-08
#>  [6,] 1.442825e-06 7.639200e-08 8.161731e-09 1.235278e-07 4.368609e-08
#>  [7,] 1.437249e-07 3.696277e-08 4.099080e-06 1.131123e-08 1.607805e-08
#>  [8,] 1.078506e-06 3.497617e-08 4.182280e-07 6.915019e-07 9.789639e-08
#>  [9,] 7.675484e-08 2.148120e-06 1.841685e-07 2.342044e-07 1.713009e-08
#> [10,] 2.781496e-07 1.550404e-07 1.913979e-07 4.821868e-07 5.690571e-07
#> [11,] 4.030265e-07 1.364649e-05 8.662905e-07 1.094429e-07 3.019317e-07
#> [12,] 2.853635e-07 1.035722e-06 1.248195e-06 1.539139e-06 6.531209e-05
#> [13,] 7.154630e-07 5.056973e-07 5.720648e-07 2.512433e-07 3.997466e-07
#> [14,] 3.192322e-05 2.655662e-06 1.133153e-06 3.501194e-08 3.177518e-07
#> [15,] 1.223599e-06 6.173064e-06 2.565832e-06 6.535432e-07 4.366864e-07
#> [16,] 3.703150e-06 1.202635e-06 3.023286e-06 2.069073e-06 1.571834e-06
#> [17,] 1.541322e-06 4.207910e-06 4.695087e-06 3.073141e-06 2.627747e-06
#> [18,] 1.312804e-05 4.408733e-07 2.154293e-06 1.539842e-06 5.671674e-06
#> [19,] 3.603971e-07 1.902746e-05 8.123247e-07 4.094441e-06 2.209542e-07
#> [20,] 1.423707e-05 8.069586e-05 2.440665e-05 2.871509e-04 6.877259e-06
```
