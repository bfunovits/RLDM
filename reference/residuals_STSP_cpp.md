# Residuals of a statespace system

This internal helper function computes the residuals (and the
directional derivatives of the residuals) for a statespace system of the
form \$\$a\_{t+1} = A a_t + B u_t, \\ y_t = C a_t + D u_t\$\$ The system
must be square and non-empty, i.e. \\m=n\>0\\.

## Usage

``` r
residuals_STSP_cpp(A, B, C, D, y, a, u, dPI, dU)
```

## Arguments

- A:

  \\(s,s)\\ matrix.

- B:

  \\(s,m)\\ matrix.

- C:

  \\(m,s)\\ matrix.

- D:

  \\(m,m)\\ matrix, must be regular.

- y:

  \\(m,N)\\ matrix with the outputs: \\(y_1,y_2,\ldots,y_N)\\.

- a:

  \\(s,N+1)\\ matrix. This matrix is overwritten with the (computed)
  states: \\(a_1,a_2,\ldots,a_N,a\_{N+1})\\. On input `a[,1]` must hold
  the initial state \\a_1\\.

- u:

  \\(m,N)\\ matrix. This matrix is overwritten with (computed)
  residuals: \\(u_1,u_2,\ldots,u_N)\\.

- dPI:

  \\((m+s)^2,K)\\ matrix.

- dU:

  \\(mN,K)\\ matrix or \\(0,0)\\ matrix. This matrix is overwritten with
  the directional derivatives of the residuals. However, if the matrix
  is empty then no derivatives are computed.

## Value

This RcppArmadillo implementation returns `NULL` but **overwrites** the
input arguments `a`, `u` and `dU`!

## Note

Use this procedure with care!

- The procedure does **not** check the input arguments.

- The procedure **overwrites** the input arguments `a`, `u` and `dU`.

- The data matrices are organized columnwise (to avoid memory
  shuffling)!

## See also

[`outputs_ARMA_cpp`](https://bfunovits.github.io/RLDM/reference/outputs_ARMA_cpp.md),
[`residuals_ARMA_cpp`](https://bfunovits.github.io/RLDM/reference/residuals_ARMA_cpp.md),
[`cll_theta_ARMA_cpp`](https://bfunovits.github.io/RLDM/reference/cll_theta_ARMA_cpp.md),
[`outputs_STSP_cpp`](https://bfunovits.github.io/RLDM/reference/outputs_STSP_cpp.md),
`residuals_STSP_cpp`,
[`cll_theta_STSP_cpp`](https://bfunovits.github.io/RLDM/reference/cll_theta_STSP_cpp.md)
and
[`solve_de`](https://bfunovits.github.io/RLDM/reference/solve_de.md),
[`solve_inverse_de`](https://bfunovits.github.io/RLDM/reference/solve_de.md)
and [`ll`](https://bfunovits.github.io/RLDM/reference/ll.md).

## Examples

``` r
# generate a random statespace model (3 outputs, 3 inputs and 4 states)
m = 2
s = 3
model = test_stspmod(dim = c(m, m), s = s, digits = 2)

# generate random noise sequence (sample size N = 10)
n.obs = 10
u = matrix(rnorm(n.obs*m), nrow = m, ncol = n.obs)

# generate matrix for the state sequence
a = matrix(0, nrow = s, ncol = n.obs+1)
a[,1] = rnorm(s) # random initial state a[1]

# generate matrix for the outputs
y = matrix(0, nrow = m, ncol = n.obs)

# compute outputs and states
outputs_STSP_cpp(model$sys$A, model$sys$B, model$sys$C, model$sys$D, u, a, y)

# recompute the states and disturbances/residuals from the given outputs:
uu = u + 0 # "deep copy" of the disturbances
aa = a + 0 # and the states
aa[, 2:(n.obs+1)] = 0 # clear all states a[t], t > 1
residuals_STSP_cpp(model$sys$A, model$sys$B, model$sys$C, model$sys$D,
                   y, aa, uu, diag(0), diag(0))
all.equal(u, uu) # check
#> [1] TRUE
all.equal(a, aa) # check
#> [1] TRUE

# compute directional derivatives of residuals
dPI = diag((m+s)^2)
dU = matrix(0, nrow = n.obs*m, ncol = ncol(dPI))
residuals_STSP_cpp(model$sys$A, model$sys$B, model$sys$C, model$sys$D,
                   y, aa, uu, dPI, dU)

# check the directional derivatives
eps = 1e-8
dU_num = matrix(0, nrow = m*n.obs, ncol = (m+s)^2)
dPI = matrix(0, nrow = (m+s), ncol = (m+s))
for (k in (1:((m+s)^2))) {
  dPI[] = 0
  dPI[k] = eps
  uu = u + 0 # "deep copy" of the disturbances
  aa = a + 0 # and the states
  residuals_STSP_cpp(model$sys$A + dPI[1:s,1:s],
                     model$sys$B + dPI[1:s,(s+1):(s+m)],
                     model$sys$C + dPI[(s+1):(s+m),1:s],
                     model$sys$D + dPI[(s+1):(s+m),(s+1):(s+m)],
                     y, aa, uu, diag(0), diag(0))
  dU_num[, k] = c(uu - u )/eps  # num. approx. of the derivative in direction "dPI"
}
# relative error of the numerical approximation
junk = (abs(dU)+abs(dU_num))
junk[junk == 0] = 1
2*abs(dU_num - dU)/junk
#>               [,1]         [,2]         [,3]         [,4]         [,5]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 2.941371e-08 0.000000e+00
#>  [2,] 2.000000e+00 2.000000e+00 2.000000e+00 2.000000e+00 7.966167e-09
#>  [3,] 1.323619e-07 4.931138e-08 7.895611e-08 7.092010e-08 1.182013e-08
#>  [4,] 2.860996e-08 6.623199e-08 1.424939e-08 3.511900e-08 3.266407e-08
#>  [5,] 1.426027e-08 4.170071e-09 1.774511e-08 1.000876e-07 8.327800e-09
#>  [6,] 2.597297e-07 7.809321e-08 1.002004e-07 3.067129e-08 8.012674e-09
#>  [7,] 4.528041e-08 1.009912e-08 5.938559e-07 1.857393e-08 3.196471e-10
#>  [8,] 1.983580e-08 6.089617e-08 2.860093e-08 6.580872e-09 3.133063e-08
#>  [9,] 1.293590e-08 1.871021e-08 3.898990e-08 2.508928e-08 1.542619e-08
#> [10,] 1.402666e-07 7.630924e-09 2.538018e-08 1.034221e-08 5.749908e-08
#> [11,] 5.870360e-08 2.326964e-08 2.378299e-07 3.835333e-08 2.851029e-08
#> [12,] 7.595212e-09 5.934009e-08 2.112861e-07 8.514201e-08 7.422990e-08
#> [13,] 5.850927e-09 1.800359e-08 1.631632e-07 4.842351e-08 2.264254e-08
#> [14,] 4.492940e-08 2.964343e-08 5.004095e-08 5.231009e-09 1.282689e-07
#> [15,] 4.678318e-08 1.263684e-09 4.169427e-08 1.858318e-08 1.288966e-08
#> [16,] 3.348001e-08 4.771560e-08 8.520807e-08 6.425257e-08 4.084121e-08
#> [17,] 3.895673e-08 3.600991e-09 1.161267e-07 6.058685e-08 4.826482e-09
#> [18,] 1.073978e-08 4.926595e-09 7.655653e-08 7.763141e-08 1.531761e-09
#> [19,] 1.225784e-08 7.823729e-09 8.285753e-08 1.313272e-09 6.366661e-09
#> [20,] 1.592796e-07 4.380687e-08 3.013109e-07 1.635318e-07 4.559093e-08
#>               [,6]         [,7]         [,8]         [,9]        [,10]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 2.881805e-11 0.000000e+00
#>  [2,] 2.000000e+00 2.000000e+00 2.000000e+00 2.000000e+00 9.575519e-09
#>  [3,] 7.248583e-08 2.542905e-08 4.453794e-08 1.017810e-06 1.061883e-08
#>  [4,] 4.903917e-08 6.694412e-08 1.244401e-08 2.355255e-08 1.544267e-08
#>  [5,] 2.019778e-08 2.071621e-08 2.973336e-08 8.743186e-09 4.768203e-08
#>  [6,] 9.295473e-08 2.366466e-08 3.239653e-08 7.400954e-08 1.180308e-08
#>  [7,] 7.118910e-08 2.709597e-08 4.968033e-08 4.629561e-08 5.862025e-09
#>  [8,] 6.812220e-08 1.513280e-08 2.659318e-08 4.656004e-07 2.570852e-07
#>  [9,] 4.691254e-08 2.487324e-08 3.229785e-08 8.654113e-08 1.438185e-08
#> [10,] 5.278518e-07 3.984327e-08 9.537111e-08 7.580142e-08 4.708178e-08
#> [11,] 5.984729e-08 4.789147e-09 2.081308e-07 6.792823e-08 2.116387e-08
#> [12,] 1.040074e-07 5.486722e-08 8.799054e-08 1.883671e-06 4.632073e-08
#> [13,] 2.516501e-08 3.463798e-08 2.307578e-08 7.955473e-08 8.916622e-09
#> [14,] 5.490995e-08 1.446921e-08 1.145018e-07 8.761998e-08 3.904314e-08
#> [15,] 1.946600e-08 2.108117e-08 1.388144e-07 2.871029e-08 1.242312e-09
#> [16,] 1.454118e-08 8.413752e-08 1.162556e-06 1.464336e-07 1.657342e-08
#> [17,] 1.618968e-09 3.141052e-08 1.407113e-08 1.177947e-08 1.583229e-10
#> [18,] 2.201081e-09 1.716905e-08 1.418126e-07 7.582782e-08 9.129461e-08
#> [19,] 1.405383e-08 2.877418e-08 7.594477e-08 4.180131e-08 2.634832e-08
#> [20,] 4.087692e-08 2.663685e-08 2.806262e-07 2.033450e-07 3.609620e-08
#>              [,11]        [,12]        [,13]        [,14]        [,15]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 7.973343e-08 0.000000e+00
#>  [2,] 2.000000e+00 2.000000e+00 2.000000e+00 2.000000e+00 1.967356e-08
#>  [3,] 2.282659e-07 3.152623e-07 1.536118e-07 1.250674e-06 1.505344e-09
#>  [4,] 2.024364e-07 1.899799e-07 5.702262e-08 1.394162e-07 1.473690e-07
#>  [5,] 1.228368e-07 6.532939e-08 5.442489e-08 2.712306e-08 2.269907e-07
#>  [6,] 5.400837e-08 7.384711e-07 1.719048e-06 4.731884e-08 2.021468e-09
#>  [7,] 4.161352e-08 1.563505e-07 1.451158e-07 5.036382e-08 2.316459e-08
#>  [8,] 1.357749e-08 2.046310e-07 1.047868e-07 4.682246e-08 7.585794e-09
#>  [9,] 2.950945e-08 1.565990e-08 1.094895e-06 2.876973e-08 5.200278e-09
#> [10,] 7.865839e-08 1.435089e-07 9.186137e-09 3.808663e-08 9.026538e-09
#> [11,] 4.614745e-08 5.411325e-08 2.656472e-08 9.751159e-08 2.108639e-08
#> [12,] 1.068125e-07 4.875514e-08 1.694566e-08 7.865030e-08 5.933020e-09
#> [13,] 3.262173e-08 6.448147e-09 1.710743e-08 8.214841e-10 3.744370e-09
#> [14,] 6.388941e-08 6.131166e-08 9.487218e-08 1.276395e-07 1.140067e-08
#> [15,] 2.099339e-10 2.274203e-08 1.794526e-07 7.871745e-08 6.501356e-09
#> [16,] 6.012462e-08 3.145856e-08 4.280834e-08 9.081650e-08 1.691237e-08
#> [17,] 6.176227e-09 1.425033e-08 5.625193e-08 2.130084e-08 1.171662e-08
#> [18,] 1.414073e-08 2.121395e-08 7.376648e-08 1.165911e-07 3.216307e-08
#> [19,] 1.483784e-08 4.373480e-09 1.400136e-07 5.380136e-08 3.071866e-10
#> [20,] 4.473260e-08 4.551741e-08 6.598846e-08 6.741088e-08 4.178792e-08
#>              [,16]        [,17]        [,18]        [,19]        [,20]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 4.121259e-10 0.000000e+00
#>  [2,] 2.000000e+00 2.000000e+00 2.000000e+00 2.000000e+00 1.365368e-08
#>  [3,] 1.149996e-07 6.660417e-08 7.535072e-08 1.165491e-07 6.903567e-09
#>  [4,] 6.966087e-09 7.317289e-08 2.369125e-08 1.822731e-07 2.569778e-08
#>  [5,] 8.177752e-08 1.969069e-09 1.963408e-08 1.303733e-07 1.892513e-08
#>  [6,] 3.601979e-08 1.308555e-06 2.124392e-08 3.402255e-06 4.344250e-08
#>  [7,] 1.013590e-07 1.486348e-07 5.413576e-09 8.913106e-08 2.945288e-08
#>  [8,] 8.436401e-08 2.821498e-07 3.390099e-08 2.415578e-07 2.861005e-07
#>  [9,] 7.370434e-08 6.012152e-08 1.140294e-07 4.030284e-07 2.696684e-07
#> [10,] 2.192391e-07 1.288584e-07 6.449751e-07 6.725504e-11 2.650456e-07
#> [11,] 8.477519e-07 6.057641e-08 1.298200e-07 5.299816e-08 1.525460e-07
#> [12,] 5.197619e-08 1.543955e-07 1.527280e-07 4.943354e-08 8.432048e-08
#> [13,] 2.583723e-09 4.087525e-09 2.875900e-07 1.437610e-06 7.025837e-08
#> [14,] 2.198393e-07 7.541248e-08 1.006742e-08 1.267471e-07 3.850338e-08
#> [15,] 1.194423e-07 1.517430e-08 7.995441e-08 3.730760e-08 6.506659e-08
#> [16,] 8.079763e-07 1.038212e-07 1.012212e-07 1.585011e-05 3.111442e-08
#> [17,] 2.177500e-08 4.802020e-08 7.324602e-07 2.881011e-07 1.250368e-08
#> [18,] 2.097218e-07 2.055495e-08 1.026495e-07 1.661281e-06 5.218113e-07
#> [19,] 6.314225e-08 2.966080e-08 1.220640e-07 5.280561e-08 3.279978e-07
#> [20,] 1.581361e-08 9.941546e-08 1.367463e-06 1.819330e-07 2.649041e-07
#>              [,21]        [,22]        [,23]        [,24]        [,25]
#>  [1,] 0.000000e+00 0.000000e+00 0.000000e+00 2.583826e-07 0.000000e+00
#>  [2,] 2.000000e+00 2.000000e+00 2.000000e+00 2.000000e+00 2.088507e-08
#>  [3,] 3.001404e-07 1.460949e-07 2.266264e-07 2.995725e-08 5.397657e-08
#>  [4,] 1.407299e-07 8.905564e-08 3.872526e-08 1.444178e-07 1.296238e-08
#>  [5,] 1.922313e-10 9.062531e-08 9.259868e-08 7.114987e-07 2.204251e-07
#>  [6,] 1.329972e-07 5.899715e-07 1.105610e-07 9.307232e-07 1.718560e-08
#>  [7,] 4.841038e-07 3.721351e-08 2.863618e-07 6.797296e-07 4.109152e-08
#>  [8,] 7.349757e-08 3.676666e-07 1.004935e-07 1.651943e-07 3.138052e-07
#>  [9,] 4.548874e-09 8.922154e-08 1.021003e-07 2.204555e-07 2.202143e-06
#> [10,] 1.666730e-07 4.438526e-07 2.093011e-06 3.008767e-07 2.857587e-04
#> [11,] 2.899053e-06 1.138774e-07 2.706892e-06 6.203765e-07 8.938434e-07
#> [12,] 5.039889e-07 8.685609e-07 3.202163e-07 2.250761e-07 2.357651e-07
#> [13,] 2.462816e-08 1.223484e-07 2.041031e-06 2.134768e-06 3.414647e-08
#> [14,] 9.577582e-07 5.584082e-07 2.924082e-07 2.566201e-07 1.537374e-07
#> [15,] 3.189034e-07 2.240887e-07 1.185965e-06 6.288940e-07 1.240094e-06
#> [16,] 7.210762e-07 5.248541e-07 3.740927e-07 1.600956e-06 5.780689e-08
#> [17,] 8.982719e-07 2.539732e-07 2.332900e-06 1.440319e-06 2.200996e-07
#> [18,] 1.414907e-07 7.220807e-07 1.852326e-07 4.321425e-06 8.764079e-07
#> [19,] 2.915811e-07 2.275871e-07 7.848724e-07 9.723181e-07 2.566885e-07
#> [20,] 2.259479e-06 1.246954e-06 3.480474e-06 2.687053e-07 1.146239e-06
```
