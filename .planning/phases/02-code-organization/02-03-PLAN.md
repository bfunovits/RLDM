---
phase: 02-code-organization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - DESCRIPTION
  - NAMESPACE
autonomous: true

must_haves:
  truths:
    - "DESCRIPTION has version constraints for all dependencies"
    - "Unused imports are removed from DESCRIPTION and NAMESPACE"
    - "rationalmatrices dependency remains as Remotes (GitHub-only)"
    - "Import/Depends distinction is correct (rationalmatrices in Depends, others in Imports)"
    - "Version constraints are conservative and based on current usage"
  artifacts:
    - path: "DESCRIPTION"
      provides: "Package dependency specification"
      contains: "Version constraints like 'dplyr (>= 1.0.0)', 'MASS (>= 7.3-60)'"
    - path: "NAMESPACE"
      provides: "Function imports and exports"
      contains: "Only actually used imports from DESCRIPTION"
  key_links:
    - from: "DESCRIPTION Imports/Depends"
      to: "Actual usage in R code"
      via: "Function calls in package source"
      pattern: "library\\(|require\\(|:: calls"
    - from: "NAMESPACE import/importFrom"
      to: "DESCRIPTION dependencies"
      via: "Consistent dependency specification"
      pattern: "importFrom.* matches DESCRIPTION"
    - from: "rationalmatrices dependency"
      to: "Remotes field"
      via: "GitHub-only package specification"
      pattern: "Remotes:.*bfunovits/rationalmatrices"
---

<objective>
Review and update DESCRIPTION file dependencies with version constraints and remove unused imports.

Purpose: Ensure package stability by adding version constraints to prevent breakage when dependencies update, and clean up unused imports to reduce dependency surface area. Maintain rationalmatrices as a Remotes dependency since it's GitHub-only.

Output: Updated DESCRIPTION with version constraints for all dependencies, removal of unused imports, and proper Import/Depends distinction.
</objective>

<execution_context>
@/home/bernd/.claude/get-shit-done/workflows/execute-plan.md
@/home/bernd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-code-organization/02-RESEARCH.md
@.planning/phases/02-code-organization/02-CONTEXT.md

# Dependency management from research
- Add version constraints to all dependencies (e.g., 'dplyr (>= 1.0.0)')
- Keep rationalmatrices in Remotes field (GitHub-only installation)
- Use Depends for rationalmatrices (required for package to function)
- Use Imports for other packages (used by package functions)
- Remove unused imports to reduce dependency surface
- Check actual usage of each dependency in R code
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze current dependency usage in R code</name>
  <files>R/01_representations_classes.R, R/02_templates.R, R/03_properties_*.R, R/04_timeseries_*.R, R/05_estimation_*.R, R/06_visualization_*.R, R/07_comparison_metrics.R, R/08_utilities_*.R, R/RcppExports.R, R/RLDM-package.R</files>
  <action>
1. Examine all R files to determine which dependencies are actually used:
   - Search for `library()`, `require()`, and `::` calls
   - Check for function calls from imported packages
   - Look for S3 method registrations that require specific packages

2. For each dependency in DESCRIPTION, verify it's actually used:
   - dplyr: Check for `%>%`, `filter()`, `mutate()`, etc.
   - MASS: Check for `ginv()`, `mvrnorm()`, etc.
   - purrr: Check for `map()`, `reduce()`, etc.
   - Rcpp: Check for `evalCpp()`, `sourceCpp()` calls
   - Rdpack: Check for `reprompt()` usage
   - tibble: Check for `tibble()` usage
   - QZ: Check for `qz()`, `gges()` usage

3. Also check Suggests dependencies:
   - DiagrammeR, kableExtra, knitr, lubridate, mvbutils, printr, rmarkdown, testthat, xts
   - These are for vignettes, tests, and optional functionality

4. Create a usage matrix:
   - List each dependency
   - Note which files/functions use it
   - Flag dependencies with no usage found

5. Pay special attention to rationalmatrices:
   - It's in Depends (not Imports) because package functions depend on it
   - Check that it's properly used throughout the codebase
  </action>
  <verify>
- Create a table showing each dependency and where it's used
- Identify any dependencies with zero usage in R code
- Verify rationalmatrices is properly used (essential dependency)
- Check that Remotes field correctly specifies bfunovits/rationalmatrices
  </verify>
  <done>
- Complete understanding of which dependencies are actually used
- Identification of potentially unused imports
- Documentation of rationalmatrices usage patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Add version constraints to DESCRIPTION dependencies</name>
  <files>DESCRIPTION</files>
  <action>
1. Based on current usage analysis, add conservative version constraints:
   - For CRAN packages: Use current version or slightly older
   - Example: 'dplyr (>= 1.0.0)', 'MASS (>= 7.3-60)', 'purrr (>= 0.3.0)'
   - For R: 'R (>= 3.6.0)' (current is >= 2.10, update to reasonable minimum)

2. Determine appropriate constraints:
   - Check package documentation or NEWS for breaking changes
   - Use versions that have been stable for at least 1-2 years
   - Be conservative but not overly restrictive

3. Update DESCRIPTION file:
   - Add version constraints to Imports, Depends, Suggests
   - Maintain rationalmatrices in Depends with Remotes specification
   - Keep Rcpp, RcppArmadillo in LinkingTo (no version constraints needed here)

4. Example transformations:
   - `dplyr` → `dplyr (>= 1.0.0)`
   - `MASS` → `MASS (>= 7.3-60)`
   - `purrr` → `purrr (>= 0.3.0)`
   - `R (>= 2.10)` → `R (>= 3.6.0)` (updated to reasonable minimum)

5. For Suggests dependencies used in vignettes/tests:
   - Add constraints: `testthat (>= 2.1.0)` (already has), `knitr (>= 1.30)`, etc.
   - These are less critical but good practice

6. Verify DESCRIPTION syntax is valid after changes.
  </action>
  <verify>
- Check updated DESCRIPTION has valid syntax
- Verify all dependencies have version constraints
- Confirm rationalmatrices remains in Depends with Remotes
- Ensure R version constraint is reasonable (>= 3.6.0)
- Test with `devtools::check()` to ensure no immediate issues
  </verify>
  <done>
- DESCRIPTION updated with version constraints for all dependencies
- Conservative version bounds based on current usage
- Valid DESCRIPTION syntax maintained
- rationalmatrices properly configured as Remotes dependency
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove unused imports and clean NAMESPACE</name>
  <files>DESCRIPTION, NAMESPACE</files>
  <action>
1. Based on usage analysis from Task 1, identify unused imports:
   - If a dependency has zero usage in R code, consider removing it
   - Check if it's used in C++ code (Rcpp headers) or build process
   - Be cautious - some imports might be for re-export or S3 methods

2. Remove truly unused imports from DESCRIPTION:
   - Update Imports field to remove unused packages
   - Keep packages used even if only in one place
   - Document why each removal decision was made

3. Update NAMESPACE if needed:
   - Remove `importFrom()` for packages no longer imported
   - Keep `import(rationalmatrices)` since it's in Depends
   - Update `importFrom()` for packages that remain

4. Verify changes don't break anything:
   - Run `devtools::document()` to regenerate NAMESPACE
   - Run `devtools::load_all()` to test package loading
   - Check for missing function errors

5. Special considerations:
   - `Rdpack` might be used for documentation macros (keep if used)
   - `magrittr` is imported for `%>%` re-export (keep)
   - `Rcpp` imports are for `evalCpp()`, `sourceCpp()` (keep)

6. Final check: Ensure DESCRIPTION and NAMESPACE are consistent.
  </action>
  <verify>
- Run `devtools::check()` to verify no missing dependencies
- Test `devtools::load_all()` succeeds
- Verify package functions work without removed imports
- Check NAMESPACE only contains imports for actually used functions
  </verify>
  <done>
- Unused imports removed from DESCRIPTION
- NAMESPACE cleaned to match actual imports
- Package still loads and functions correctly
- Dependency surface area reduced
  </done>
</task>

</tasks>

<verification>
1. Run `devtools::check()` to ensure package still passes basic checks
2. Test `devtools::install()` locally to verify installation works with new constraints
3. Verify `remotes::install_github("bfunovits/rationalmatrices")` would still work as Remotes dependency
</verification>

<success_criteria>
- [x] All dependencies in DESCRIPTION have version constraints
- [x] Unused imports are removed from DESCRIPTION and NAMESPACE
- [x] rationalmatrices remains as Remotes dependency in Depends
- [x] Package passes `devtools::check()` with 0 errors
- [x] Version constraints are conservative and based on actual usage
</success_criteria>

<output>
After completion, create `.planning/phases/02-code-organization/02-03-SUMMARY.md`
</output>