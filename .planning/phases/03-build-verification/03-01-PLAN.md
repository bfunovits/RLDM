---
phase: 03-build-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Build environment is clean (no .o/.so artifacts in src/)"
    - "All dependencies including rationalmatrices are installed"
    - "Initial devtools::check() results are captured in log file"
  artifacts:
    - path: ".planning/phases/03-build-verification/check-initial.log"
      provides: "Initial check results with all errors/warnings"
      min_lines: 20
    - path: "src/"
      provides: "Clean C++ source directory"
      contains: "No .o or .so files after cleanup"
  key_links:
    - from: "clean environment"
      to: "reproducible check results"
      via: "removing build artifacts before verification"
      pattern: "unlink.*\\.(o|so|dll)"
    - from: "rationalmatrices installation"
      to: "package can build"
      via: "remotes::install_github"
      pattern: "install_github.*rationalmatrices"
---

<objective>
Run initial build verification in clean environment to identify all issues.

Purpose: Establish baseline verification state, capture all errors and warnings for analysis in Plan 03-02.
Output: Clean src/ directory, installed dependencies, comprehensive check log file.
</objective>

<execution_context>
@/home/bernd/.claude/get-shit-done/workflows/execute-plan.md
@/home/bernd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-build-verification/03-CONTEXT.md
@.planning/phases/03-build-verification/03-RESEARCH.md

# Phase 2 decisions affecting build verification
- [02-04 Execution]: Establish build artifact cleanup workflow: remove *.o, *.so, *.dll after compilation
- [02-04 Execution]: Accept line length exceptions for C++ code (some lines > 80 chars, up to 180 chars)
- [02-04 Execution]: Document test infrastructure issues rather than fixing them in code organization phase

# Known blockers from STATE.md
- Test infrastructure: pfilter tests fail due to test environment setup issues
- Vignette build failures: Package build fails due to pandoc-citeproc missing and vignette coercion errors
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean build environment and install dependencies</name>
  <files>src/, .planning/phases/03-build-verification/check-initial.log</files>
  <action>
1. Clean C++ build artifacts from src/ directory:
   - Remove all *.o, *.so, *.dll files from src/
   - Keep source files (.cpp) and Makevars files
   - Use pattern: `unlink(list.files("src", pattern = "\\.(o|so|dll)$", full.names = TRUE))`

2. Install sister package rationalmatrices:
   - Check if rationalmatrices is already installed: `requireNamespace("rationalmatrices", quietly = TRUE)`
   - If not installed, install from GitHub: `remotes::install_github("bfunovits/rationalmatrices")`
   - Use remotes package (already in Suggests, install if needed)

3. Install package dependencies:
   - Run `devtools::install_deps(dependencies = TRUE)` to ensure all Imports and Suggests are installed
   - This includes testthat, knitr, rmarkdown for checking

4. Create verification log directory:
   - Ensure `.planning/phases/03-build-verification/` exists
   - Create empty log file: `check-initial.log`

Why: Clean environment ensures reproducible check results. Sister package is required for building. All dependencies must be installed for comprehensive checking.
  </action>
  <verify>
- Run `ls -la src/` and confirm no .o or .so files remain
- Run `Rscript -e "requireNamespace('rationalmatrices', quietly = TRUE)"` returns TRUE
- Run `Rscript -e "all(c('devtools', 'testthat', 'knitr') %in% installed.packages()[,1])"` returns TRUE
- File `.planning/phases/03-build-verification/check-initial.log` exists
  </verify>
  <done>Clean src/ directory, rationalmatrices installed, all dependencies available, log file created.</done>
</task>

<task type="auto">
  <name>Task 2: Run initial devtools::check() with comprehensive logging</name>
  <files>.planning/phases/03-build-verification/check-initial.log</files>
  <action>
1. Run devtools::check() with default arguments:
   - Use `devtools::check(document = TRUE, manual = TRUE, cran = FALSE)`
   - `document = TRUE`: Update documentation first (ensures NAMESPACE is current)
   - `manual = TRUE`: Include manual checks
   - `cran = FALSE`: Don't use --as-cran flag (per phase decision)

2. Capture all output to log file:
   - Redirect stdout and stderr to `check-initial.log`
   - Use `sink()` or `capture.output()` to capture R output
   - Also capture system command output

3. Parse and summarize results:
   - Extract errors, warnings, notes from check output
   - Count each category
   - Log summary at top of file for quick reference

4. Handle expected issues gracefully:
   - pfilter test failures (known issue from STATE.md) - log but don't fail
   - Vignette build issues - capture errors for analysis
   - Non-ASCII character warnings (acceptable per phase decision)

Why: Comprehensive logging ensures all issues are captured for Plan 03-02. Default check settings match phase decisions. Capturing both stdout and stderr ensures complete record.
  </action>
  <verify>
- File `.planning/phases/03-build-verification/check-initial.log` contains check output
- Log includes timestamp and check command used
- Log shows error/warning/note counts
- Check completed (didn't crash mid-execution)
  </verify>
  <done>Comprehensive check log created with all errors, warnings, and notes captured for analysis.</done>
</task>

</tasks>

<verification>
1. Inspect `check-initial.log`:
   - Look for "ERROR" count - should be 0 for build to pass
   - Look for "WARNING" count - record for Plan 03-02 analysis
   - Look for test failures - note pfilter test is expected to fail

2. Verify environment:
   - `src/` directory contains only source files, no build artifacts
   - `rationalmatrices` package is installed and loadable

3. Check log structure:
   - Contains check command used
   - Has error/warning/note summary
   - Includes full check output
</verification>

<success_criteria>
- [ ] `check-initial.log` file exists with â‰¥20 lines
- [ ] `src/` directory contains no .o or .so files
- [ ] `rationalmatrices` package installed (Rscript check returns TRUE)
- [ ] Check completed without R session crash
</success_criteria>

<output>
After completion, create `.planning/phases/03-build-verification/03-01-SUMMARY.md` with:
- Clean environment status
- Dependencies installed
- Check results summary (errors/warnings/notes counts)
- Issues identified for Plan 03-02
</output>