---
phase: 03-build-verification
plan: 05
type: execute
wave: 2
depends_on: ["03-03", "03-04"]
files_modified: ["DESCRIPTION", "README.md", ".planning/phases/03-build-verification/final-verification.log", ".planning/phases/03-build-verification/build-status.md"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Package check passes with 0 errors and ≤1 warning (BUILD-01 achieved)"
    - "Vignette system dependency is properly documented or resolved"
    - "Final verification confirms all gap closures are complete"
  artifacts:
    - path: ".planning/phases/03-build-verification/final-verification.log"
      provides: "Final check results meeting BUILD-01 criteria"
      min_lines: 50
    - path: ".planning/phases/03-build-verification/build-status.md"
      provides: "Comprehensive build status report"
      min_lines: 15
    - path: "DESCRIPTION"
      provides: "Updated system requirements if needed"
      contains: ["SystemRequirements:" if pandoc-citeproc documented]
  key_links:
    - from: "gap closure plans (03-03, 03-04)"
      to: "final verification"
      via: "accumulated fixes"
      pattern: "gap_closure: true"
    - from: "system dependency documentation"
      to: "user installation instructions"
      via: "README.md or DESCRIPTION"
      pattern: "pandoc-citeproc|system requirements"
    - from: "final check results"
      to: "BUILD-01 achievement"
      via: "error/warning count"
      pattern: "Status:.*ERROR.*WARNING"
---

<objective>
Complete final verification after gap closures, addressing vignette system dependency and confirming BUILD-01 (0 errors, ≤1 warning) is achieved.

Purpose: Verify all gaps from VERIFICATION.md are closed, handle vignette system dependency (pandoc-citeproc) appropriately, and run final comprehensive check to confirm build verification phase success.
Output: Final verification showing package meets BUILD-01 criteria, system dependencies documented, and gap closure complete.
</objective>

<execution_context>
@/home/bernd/.claude/get-shit-done/workflows/execute-plan.md
@/home/bernd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-build-verification/03-VERIFICATION.md
@.planning/phases/03-build-verification/03-03-SUMMARY.md
@.planning/phases/03-build-verification/03-04-SUMMARY.md

# Remaining gaps after documentation and test fixes:
# 1. Vignette system dependency: pandoc-citeproc required for vignette building
# 2. Final verification needed to confirm BUILD-01 (0 errors, ≤1 warning)
#
# From previous plans:
# - 03-03: Fixed documentation errors (examples, cross-references, usage, LaTeX)
# - 03-04: Addressed test infrastructure issues
#
# This plan completes gap closure with final verification.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Address vignette system dependency</name>
  <files>DESCRIPTION, README.md, .planning/phases/03-build-verification/vignette-dependency.md</files>
  <action>
1. **Analyze pandoc-citeproc dependency:**
   - Check if pandoc-citeproc is available: `system("which pandoc-citeproc", intern = TRUE)`
   - Determine if it's required for vignette building or optional
   - Check vignette building options in devtools::check()

2. **Document system requirement (choose appropriate approach):**

   **Option A: Add to DESCRIPTION SystemRequirements (if essential):**
   ```
   SystemRequirements: pandoc-citeproc
   ```

   **Option B: Document in README.md (if optional but recommended):**
   - Add note about vignette building requiring pandoc-citeproc
   - Provide installation instructions for different platforms

   **Option C: Skip vignettes in check (already done, but document):**
   - Document that vignettes are skipped due to system dependency
   - Note in build-status.md

3. **Update documentation:**
   - Choose appropriate option based on analysis
   - Update DESCRIPTION or README.md accordingly
   - Create vignette-dependency.md with detailed analysis

4. **Test vignette building (if pandoc-citeproc available):**
   - If available: `devtools::build_vignettes()` to test
   - If not: document as external system requirement
  </action>
  <verify>DESCRIPTION or README.md contains appropriate documentation about pandoc-citeproc requirement; vignette-dependency.md documents analysis.</verify>
  <done>Vignette system dependency is properly documented as either required, recommended, or skipped with explanation.</done>
</task>

<task type="auto">
  <name>Task 2: Run final comprehensive check</name>
  <files>.planning/phases/03-build-verification/final-verification.log, .planning/phases/03-build-verification/build-status.md</files>
  <action>
1. **Run full devtools::check() with all fixes applied:**
   - Clean environment: remove src/*.o, src/*.so files
   - Run: `devtools::check(document = FALSE, manual = TRUE, cran = FALSE)`
   - Save full output to `.planning/phases/03-build-verification/final-verification.log`
   - Use `--ignore-vignettes` flag if pandoc-citeproc not available

2. **Analyze check results for BUILD-01 criteria:**
   - Count errors: should be 0 (documentation examples fixed, test issues addressed)
   - Count warnings: should be ≤1 (documentation warnings fixed)
   - Check notes: acceptable (hidden files, suggested packages)
   - Verify PDF manual builds without LaTeX errors

3. **Create build-status.md summary:**
   - Error count: 0 achieved? (list any remaining)
   - Warning count: ≤1 achieved? (list warnings)
   - Notes: list and assess
   - BUILD-01 status: achieved/not achieved
   - Remaining issues for future phases

4. **Compare with initial check results:**
   - Show improvement from check-initial.log to final-verification.log
   - Document fixes applied across all gap closure plans
  </action>
  <verify>final-verification.log shows Status: 0 ERRORs, ≤1 WARNING; build-status.md documents BUILD-01 achievement status.</verify>
  <done>Final check passes BUILD-01 criteria (0 errors, ≤1 warning); comprehensive status report created.</done>
</task>

<task type="auto">
  <name>Task 3: Verify gap closure completeness and update roadmap</name>
  <files>.planning/ROADMAP.md, .planning/STATE.md, .planning/phases/03-build-verification/gap-closure-complete.md</files>
  <action>
1. **Verify all gaps from VERIFICATION.md are addressed:**
   - Gap 1: Package check passes with 0 errors
   - Gap 2: Package check has ≤1 warning
   - Gap 3: Package can be built from source without vignette errors
   - Create gap-closure-complete.md with verification for each gap

2. **Update ROADMAP.md Phase 3 status:**
   - Update "Plans:" line to include new gap closure plans
   - Mark Phase 3 as complete if BUILD-01 achieved
   - Update progress tracking

3. **Update STATE.md current position:**
   - Move to Phase 4 if Phase 3 complete
   - Update blockers/concerns based on final status
   - Document any remaining issues for future phases

4. **Prepare for Phase 4 transition:**
   - Summarize build verification outcomes
   - Note documentation warnings for Phase 4 (documentation completeness)
   - Document test infrastructure status for future work
  </action>
  <verify>ROADMAP.md shows Phase 3 complete with all plans; STATE.md updated with current position; gap-closure-complete.md documents all gaps addressed.</verify>
  <done>All gaps from VERIFICATION.md are verified as closed; project state updated for Phase 4 transition.</done>
</task>

</tasks>

<verification>
1. Check `final-verification.log` for "Status: 0 ERRORs, X WARNINGs" - X should be ≤1
2. Verify BUILD-01 criteria met: 0 errors, ≤1 warning in final check
3. Check ROADMAP.md Phase 3 shows all plans (01-05) and marked complete
4. Verify STATE.md current position updated to Phase 4 ready
</verification>

<success_criteria>
- [ ] BUILD-01 achieved: 0 errors, ≤1 warning in final check
- [ ] Vignette system dependency properly documented
- [ ] All gaps from VERIFICATION.md addressed and verified
- [ ] ROADMAP.md updated with Phase 3 completion
- [ ] STATE.md updated for Phase 4 transition
</success_criteria>

<output>
After completion, create `.planning/phases/03-build-verification/03-05-SUMMARY.md` documenting final verification and gap closure completion.
</output>
