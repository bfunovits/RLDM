---
phase: 03-build-verification
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: ["DESCRIPTION", "NAMESPACE", "R/*.R", "man/*.Rd", "vignettes/*.Rmd"]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Namespace imports/exports are correctly declared (no 'no visible binding' warnings)"
    - "Package installs cleanly from source without errors"
    - "devtools::check() passes with 0 errors and ≤1 warning"
  artifacts:
    - path: ".planning/phases/03-build-verification/check-final.log"
      provides: "Final check results meeting success criteria"
      min_lines: 20
    - path: ".planning/phases/03-build-verification/issues-fixed.md"
      provides: "Record of issues fixed during this plan"
      min_lines: 5
  key_links:
    - from: "NAMESPACE file"
      to: "imports/exports warnings"
      via: "roxygen2 @importFrom tags"
      pattern: "@importFrom|@export"
    - from: "DESCRIPTION file"
      to: "dependency warnings"
      via: "Imports: and Suggests: fields"
      pattern: "Imports:|Suggests:"
    - from: "documentation updates"
      to: "documentation warnings"
      via: "roxygen2 comments"
      pattern: "#' @"
---

<objective>
Fix identified issues from initial check and verify package meets build verification criteria.

Purpose: Address common R package issues (namespace, imports, documentation) to achieve BUILD-01, BUILD-02, BUILD-03 requirements.
Output: Fixed package that passes devtools::check() with 0 errors and ≤1 warning, installs cleanly from source.
</objective>

<execution_context>
@/home/bernd/.claude/get-shit-done/workflows/execute-plan.md
@/home/bernd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-build-verification/03-CONTEXT.md
@.planning/phases/03-build-verification/03-RESEARCH.md
@.planning/phases/03-build-verification/03-01-SUMMARY.md
@.planning/phases/03-build-verification/vignette-issues.md

# Phase decisions affecting fixes
- One warning allowed — but investigate each warning
- Ignore R CMD check NOTES, only warnings count toward limit
- Ignore specific warning patterns (non‑ASCII characters, time verification)
- Attempt automatic fixes for common issues (e.g., missing imports)

# Common R package issues to address
1. Missing imports in NAMESPACE (functions used but not imported)
2. Missing @export tags for exported functions
3. Documentation warnings (missing parameters, examples)
4. Dependency version issues
5. Vignette build issues (if code-related, not system dependencies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze initial check results and fix common issues</name>
  <files>DESCRIPTION, NAMESPACE, R/*.R, man/*.Rd, vignettes/*.Rmd, .planning/phases/03-build-verification/issues-fixed.md</files>
  <action>
1. Parse `check-initial.log` from Plan 03-01:
   - Extract all warnings (not notes)
   - Categorize: namespace, documentation, dependencies, tests, vignettes
   - Create issue list in `issues-fixed.md`

2. Fix namespace issues:
   - For "no visible binding" warnings: add missing @importFrom tags
   - For missing exports: ensure exported functions have @export tags
   - Run `devtools::document()` to regenerate NAMESPACE and .Rd files
   - Verify NAMESPACE contains all necessary imports/exports

3. Fix documentation issues:
   - For missing parameter documentation: add @param tags
   - For missing examples: add simple @examples if possible
   - For documentation warnings: address specific issues mentioned

4. Update DESCRIPTION if needed:
   - Ensure all used packages are in Imports or Suggests
   - Check version constraints are appropriate
   - Verify Remotes: field includes rationalmatrices

5. Handle test issues:
   - pfilter test failures (known issue) - document in issues-fixed.md but don't fix
   - Other test failures - attempt fixes if simple

6. Handle vignette issues based on vignette-issues.md analysis:
   - If system dependencies missing (pandoc-citeproc): document as external issue
   - If code issues (coercion errors): attempt fixes in vignette Rmd files
   - Update issues-fixed.md with vignette resolution status

Why: Automatic fixes for common issues reduce warning count. Namespace fixes are critical for package functionality. Documentation fixes improve package quality. Vignette fixes may be needed to achieve BUILD-01 (0 errors).
  </action>
  <verify>
- File `issues-fixed.md` lists warnings from initial check and fixes applied
- `devtools::document()` runs without errors
- NAMESPACE file updated with current timestamp
- Run `R CMD check --no-manual --no-vignettes . 2>&1 | grep -i "no visible binding"` returns no matches
- Check for specific warning patterns: `grep -i "warning.*namespace\|warning.*import\|warning.*export" check-initial.log` shows reduced count
  </verify>
  <done>Namespace and documentation issues addressed, fixes documented, package documentation regenerated.</done>
</task>

<task type="auto">
  <name>Task 2: Run final verification and validate success criteria</name>
  <files>.planning/phases/03-build-verification/check-final.log</files>
  <action>
1. Clean build artifacts again:
   - Remove any .o/.so files created during documentation rebuild
   - Ensure clean environment for final check

2. Run final devtools::check():
   - Same arguments as initial check: `devtools::check(document = FALSE, manual = TRUE, cran = FALSE)`
   - `document = FALSE`: Documentation already updated in Task 1
   - Capture output to `check-final.log`

3. Analyze results against success criteria:
   - ERROR count must be 0 (BUILD-01)
   - WARNING count must be ≤1 (BUILD-01)
   - Check for namespace warnings (BUILD-02)
   - Note any remaining issues

4. Test installation from source:
   - Run `devtools::install()` or `R CMD INSTALL .`
   - Verify package loads: `library(RLDM)`
   - Check key functions work: `?armamod`, `?stspmod`

5. Create verification summary:
   - Compare initial vs final warning counts
   - Document which warnings were fixed/remain
   - Confirm BUILD-01, BUILD-02, BUILD-03 requirements met

Why: Final verification confirms fixes worked. Installation test validates BUILD-03. Comparison shows progress made.
  </action>
  <verify>
- `check-final.log` shows ERROR: 0
- `check-final.log` shows WARNING: ≤1 (excluding non-ASCII character warnings and time verification warnings)
- Package installs without errors: `devtools::install()` succeeds
- Package loads: `library(RLDM)` works
  </verify>
  <done>Package passes devtools::check() with 0 errors and ≤1 warning, installs cleanly from source.</done>
</task>

</tasks>

<verification>
1. Check `check-final.log` for success:
   - "ERROR" count: 0 ✓
   - "WARNING" count: ≤1 ✓ (excluding non-ASCII character warnings and time verification warnings)
   - No namespace warnings (no "no visible binding")

2. Verify installation:
   - `devtools::install()` exit code 0
   - `library(RLDM)` loads without errors
   - Basic functions accessible: `armamod`, `stspmod`

3. Review fixes:
   - `issues-fixed.md` documents warnings addressed
   - Warning reduction from initial to final check
   - Remaining warnings documented and justified
</verification>

<success_criteria>
- [ ] `check-final.log` shows 0 errors
- [ ] `check-final.log` shows ≤1 warning (excluding non-ASCII character warnings and time verification warnings)
- [ ] Package installs from source without errors
- [ ] Package loads successfully: `library(RLDM)`
- [ ] `issues-fixed.md` documents fixes applied
</success_criteria>

<output>
After completion, create `.planning/phases/03-build-verification/03-02-SUMMARY.md` with:
- Final check results (error/warning counts)
- Installation test results
- BUILD requirement verification status
- Remaining issues (if any) for future phases
</output>