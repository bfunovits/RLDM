---
phase: 03-build-verification
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: ["R/05_estimation_likelihood.R", "R/05_estimation_particle.R", "R/05_estimation_rls.R", "man/kf.Rd", "man/ll_FUN.Rd", "man/ll_kf.Rd", "man/pfilter.Rd", "man/solve_RMFD_R.Rd", "man/solve_inverse_RMFD_R.Rd", "man/arx_rls_core.Rd"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Documentation examples run without errors (kf_cpp function found)"
    - "Rd cross-reference warnings are resolved (ll_kf_cpp, ll_pf, solve_rmfd_cpp)"
    - "Rd usage section warnings are resolved (kf.Rd arguments match usage)"
    - "PDF manual builds without LaTeX errors (any LaTeX issues fixed)"
  artifacts:
    - path: "R/05_estimation_likelihood.R"
      provides: "Fixed documentation examples and cross-references"
      contains: ["kf() instead of kf_cpp()", "ll_kf() instead of ll_kf_cpp()", "proper \\link{} tags"]
    - path: "man/kf.Rd"
      provides: "Correct usage section matching documented arguments"
      contains: ["\\usage{kf(model, y, method = c(\"kf\", \"kf2\"), P1 = NULL, a1 = NULL)}"]
    - path: "man/arx_rls_core.Rd"
      provides: "Fixed LaTeX syntax for any LaTeX issues"
      contains: ["valid \\eqn{} syntax without LaTeX errors"]
  key_links:
    - from: "R/05_estimation_likelihood.R roxygen comments"
      to: "man/kf.Rd generated documentation"
      via: "devtools::document()"
      pattern: "#' @param"
    - from: "\\link{} tags in roxygen"
      to: "Rd cross-references"
      via: "roxygen2 processing"
      pattern: "\\link\\[=.*\\]\\{.*\\}"
    - from: "\\eqn{} LaTeX expressions"
      to: "PDF manual compilation"
      via: "Rd2pdf processing"
      pattern: "\\eqn\\{.*\\}"
---

<objective>
Fix documentation errors identified in build verification gaps: example errors, Rd cross-reference warnings, Rd usage section warnings, and PDF manual LaTeX errors.

Purpose: Address documentation issues that prevent BUILD-01 (0 errors, ≤1 warning) from being achieved. These are specific, fixable issues identified in VERIFICATION.md gaps.
Output: Documentation with working examples, correct cross-references, proper usage sections, and valid LaTeX syntax for PDF manual generation.
</objective>

<execution_context>
@/home/bernd/.claude/get-shit-done/workflows/execute-plan.md
@/home/bernd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-build-verification/03-VERIFICATION.md
@.planning/phases/03-build-verification/03-02-SUMMARY.md

# Documentation issues from check-final.log:
# 1. Example errors: kf_cpp function not found in examples
# 2. Rd cross-reference warnings: ll_kf_cpp, ll_pf, solve_rmfd_cpp
# 3. Rd usage warnings: kf.Rd has undocumented arguments in usage section
# 4. PDF manual LaTeX errors: any LaTeX syntax issues including forgetting_factors
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix documentation examples and cross-references</name>
  <files>R/05_estimation_likelihood.R, R/05_estimation_particle.R, R/05_estimation_rls.R</files>
  <action>
1. **Fix kf_cpp references in examples:**
   - In R/05_estimation_likelihood.R, ensure all examples use `kf()` wrapper function instead of `kf_cpp()`
   - Check line ~903: `# Note: kf_cpp is the internal C++ implementation called by kf()` - this is fine as comment
   - Check line ~971: `.Call(`_RLDM_kf_cpp`, ...)` - this is internal implementation, not example

2. **Fix ll_kf_cpp cross-references:**
   - In R/05_estimation_likelihood.R line 507: `#' @param tol (double) tolerance used by [ll_kf_cpp()].`
   - Change to: `#' @param tol (double) tolerance used by \code{\link[=ll_kf]{ll_kf()}}.`
   - Update any other references to internal C++ functions to point to wrapper functions

3. **Fix ll_pf cross-references:**
   - In R/05_estimation_particle.R line 65: `[ll_pf()]` should reference the wrapper function
   - Change to: `[ll_pfilter()]` (the wrapper function for particle filter log-likelihood)
   - Ensure all documentation references to ll_pf use the wrapper function ll_pfilter

4. **Fix solve_rmfd_cpp cross-references:**
   - Search for references to `solve_rmfd_cpp` in R files
   - Ensure they use proper `\link{}` syntax pointing to wrapper functions

5. **Fix any LaTeX errors in documentation:**
   - Search for LaTeX errors in PDF manual check output
   - Common issues: `\eqn{}` syntax errors, unescaped special characters, invalid LaTeX commands
   - Fix forgetting_factors issue in R/05_estimation_rls.R line 27: `\eqn{ (#forgetting_factors \times 1) }`
   - Change to valid LaTeX syntax: `\eqn{(#forgetting_factors \times 1)}` or properly escape `#`
   - Check for other LaTeX errors beyond forgetting_factors

6. **Run devtools::document() to regenerate Rd files**
   - Verify changes propagate to man/*.Rd files
  </action>
  <verify>Run `devtools::document()` and check no errors. Verify man/kf.Rd, man/ll_FUN.Rd, man/arx_rls_core.Rd contain fixes.</verify>
  <done>Documentation examples reference wrapper functions (kf(), ll_kf()) not internal C++ functions; cross-references use proper \link{} syntax; LaTeX syntax is valid.</done>
</task>

<task type="auto">
  <name>Task 2: Fix Rd usage section warnings in kf.Rd</name>
  <files>R/05_estimation_likelihood.R, man/kf.Rd</files>
  <action>
1. **Analyze the warning:** "Documented arguments not in \usage in Rd file 'kf.Rd': ‘y_t’ ‘P1_R’ ‘A’ ‘C’ ‘Q’ ‘R’ ‘S’ ‘H_t’"
   - These are parameters for internal C++ functions (kf_cpp, kf2_cpp) but appear in kf.Rd documentation
   - The kf() wrapper function has different signature: `kf(model, y, method = c("kf", "kf2"), P1 = NULL, a1 = NULL)`

2. **Fix roxygen documentation in R/05_estimation_likelihood.R:**
   - Remove `@param` tags for y_t, P1_R, A, C, Q, R, S, H_t from kf() function documentation
   - These parameters belong to internal C++ functions, not the wrapper
   - Keep documentation for actual kf() parameters: model, y, method, P1, a1

3. **Alternative approach:** If these parameters need documentation for internal functions:
   - Move them to a separate `@section Internal parameters:` or note
   - Or document them with `@details` explaining they're for internal C++ functions

4. **Regenerate documentation:**
   - Run `devtools::document()` to update man/kf.Rd
   - Verify usage section matches documented arguments

5. **Check other Rd files for similar issues:**
   - Review ll_kf.Rd, pfilter.Rd for similar usage mismatches
  </action>
  <verify>Run `R CMD check --as-cran --no-manual --no-vignettes 2>&1 | grep -A5 "Rd \\\\usage"` to check for usage warnings.</verify>
  <done>kf.Rd usage section contains only parameters actually in kf() function signature; no "Documented arguments not in \usage" warnings.</done>
</task>

<task type="auto">
  <name>Task 3: Verify fixes and run partial check</name>
  <files>.planning/phases/03-build-verification/check-documentation.log</files>
  <action>
1. **Run targeted check for documentation issues:**
   - `devtools::check(document = FALSE, manual = TRUE, cran = FALSE, args = c("--no-examples", "--no-tests"))`
   - This checks documentation without running examples or tests
   - Save output to `.planning/phases/03-build-verification/check-documentation.log`

2. **Verify specific fixes:**
   - No "Missing link(s) in Rd file" warnings (ll_kf_cpp, ll_pf, solve_rmfd_cpp)
   - No "Documented arguments not in \usage" warnings
   - No LaTeX errors in PDF manual check

3. **Check example errors separately:**
   - Run examples for kf() and ll_kf() manually: `example(kf)` and `example(ll_kf)`
   - Ensure they run without "could not find function" errors

4. **Document fixes in gap closure summary:**
   - Create `.planning/phases/03-build-verification/gap-03-fixes.md`
   - List each issue fixed with before/after code snippets
  </action>
  <verify>Check output shows 0 documentation warnings (Rd cross-references, usage sections) and 0 LaTeX errors in PDF manual check.</verify>
  <done>Documentation check passes with 0 warnings; examples run without errors; PDF manual LaTeX syntax is valid.</done>
</task>

</tasks>

<verification>
1. Run `devtools::check(document = FALSE, manual = TRUE, cran = FALSE, args = c("--no-examples", "--no-tests"))` - should show 0 documentation warnings
2. Check `check-documentation.log` for "Missing link(s)" (ll_kf_cpp, ll_pf, solve_rmfd_cpp) and "Documented arguments not in \usage" warnings - should be 0
3. Check PDF manual LaTeX errors - should be 0 (any LaTeX syntax issues resolved)
4. Run `example(kf)` and `example(ll_kf)` - should execute without "could not find function" errors
</verification>

<success_criteria>
- [ ] Documentation examples run without "kf_cpp not found" errors
- [ ] 0 Rd cross-reference warnings (ll_kf_cpp, ll_pf, solve_rmfd_cpp resolved)
- [ ] 0 Rd usage section warnings (kf.Rd arguments match usage)
- [ ] 0 PDF manual LaTeX errors (any LaTeX syntax issues fixed)
- [ ] `check-documentation.log` shows documentation checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-build-verification/03-03-SUMMARY.md` documenting fixes applied for documentation gaps.
</output>
