# Architecture Patterns

**Domain:** R package maintenance, documentation, and build verification
**Project:** RLDM Package Cleanup & Streamlining
**Researched:** 2026-01-24

## Recommended Architecture

RLDM follows a standard R package architecture with some custom organizational patterns:

```
RLDM Package Structure
├── R/                    # R source code (numeric-prefixed by workflow)
├── src/                  # C++ source code (Rcpp/RcppArmadillo)
├── man/                  # Documentation (auto-generated by roxygen2)
├── vignettes/           # Package vignettes
├── tests/               # testthat test suite
├── inst/                # Installed files
│   ├── examples/        # Example scripts
│   └── doc/             # Technical documentation
└── .github/            # GitHub Actions workflows (to be added)
```

### Component Boundaries

| Component | Responsibility | Communicates With |
|-----------|---------------|-------------------|
| `R/` directory | All R source code organized by workflow | `src/` via Rcpp, `man/` via roxygen2 |
| `src/` directory | C++ performance-critical code | `R/` via Rcpp wrappers, linking to LAPACK/BLAS |
| `man/` directory | Function documentation | Auto-generated from `R/` via roxygen2 |
| `vignettes/` | Tutorials and examples | Uses package functions, depends on Suggests |
| `tests/` | Unit and integration tests | Tests functions in `R/` and `src/` |
| `inst/` | Additional package resources | Accessed via `system.file()` at runtime |

## Patterns to Follow

### Pattern 1: Numeric-Prefixed R File Organization
**What:** R files organized by prefix indicating workflow category (01_, 02_, etc.)
**When:** For medium-to-large packages with clear functional groupings
**Example:**
```
R/
├── 01_representations_classes.R    # Model classes (armamod, stspmod, rmfdmod)
├── 02_templates.R                  # Parameter templates (tmpl_* functions)
├── 03_properties_*.R               # Derived properties (autocov, spectrald, etc.)
├── 04_timeseries_*.R               # Time series operations (sim, solve, predict)
├── 05_estimation_*.R               # Estimation methods (ML, AR, ARMA, subspace)
├── 06_visualization_*.R            # Plot methods
├── 07_comparison_*.R               # Model comparison metrics
└── 08_utilities_*.R                # Utilities (print, str, documentation)
```
**Benefits:** Clear dependency ordering, easy navigation, logical grouping

### Pattern 2: S3 Method Organization
**What:** S3 methods grouped by generic rather than scattered
**When:** Package uses S3 object system extensively
**Example:**
```r
# In 01_representations_classes.R
armamod <- function(...) { structure(...), class = "armamod" }
stspmod <- function(...) { structure(...), class = "stspmod" }

# In 03_properties_autocov.R
autocov.armamod <- function(x, ...) { ... }
autocov.stspmod <- function(x, ...) { ... }

# In 06_visualization_plot.R
plot.armamod <- function(x, ...) { ... }
plot.stspmod <- function(x, ...) { ... }
```
**Benefits:** Methods stay with their generics, easier to maintain

### Pattern 3: C++ Code Organization for Rcpp
**What:** C++ files organized by algorithm domain
**When:** Package has significant C++ code via Rcpp
**Example:**
```
src/
├── kf.cpp                    # Kalman filter implementations
├── solve_fwd_bwd_cll.cpp    # Forward-backward solving
├── rls_core.cpp             # Recursive least squares
└── particle_filter.cpp      # Particle filter (if added)
```
**Benefits:** Clear separation of concerns, easier compilation management

### Pattern 4: Documentation-First Development
**What:** Write roxygen comments before function implementation
**When:** For all exported functions
**Example:**
```r
#' Simulate from a rational linear dynamic model
#'
#' @param model An object of class `armamod`, `stspmod`, or `rmfdmod`
#' @param n.obs Number of observations to simulate
#' @param ... Additional arguments passed to methods
#'
#' @return A list with components `y` (observations) and `u` (inputs)
#' @export
#'
#' @examples
#' model <- armamod(...)
#' data <- sim(model, n.obs = 100)
sim <- function(model, n.obs, ...) {
  UseMethod("sim")
}
```
**Benefits:** Ensures documentation completeness, clarifies interface early

## Anti-Patterns to Avoid

### Anti-Pattern 1: Root Directory Clutter
**What:** Multiple loose files in package root
**Why bad:** Violates R package conventions, confusing for users and tools
**Instead:** Organize into appropriate directories:
- Benchmarks → `inst/benchmarks/` or `bench/`
- Logs → `logs/` (in `.Rbuildignore`)
- Documentation → `vignettes/` or `inst/doc/`

### Anti-Pattern 2: Manual NAMESPACE Management
**What:** Editing NAMESPACE file directly
**Why bad:** Conflicts with roxygen2, error-prone, hard to maintain
**Instead:** Use roxygen2 `@export` tags and let it generate NAMESPACE

### Anti-Pattern 3: Global Side Effects
**What:** Functions that modify `.GlobalEnv` or options without cleanup
**Why bad:** Causes hard-to-debug side effects, breaks tests
**Instead:** Use `withr::with_*()` functions for temporary changes

### Anti-Pattern 4: Inconsistent S3 Method Registration
**What:** S3 methods not properly registered or documented
**Why bad:** Methods may not work, confusing for users
**Instead:** Document all S3 methods with roxygen2, use `s3_register()` if needed

## Scalability Considerations

| Concern | Current (single maintainer) | Team Development | CRAN Publication |
|---------|----------------------------|------------------|------------------|
| Code organization | Numeric prefixes work well | Need clearer module boundaries | Must follow CRAN conventions |
| Testing | testthat suite sufficient | Need CI/CD integration | Must pass on multiple platforms |
| Documentation | Roxygen comments adequate | Need vignette maintenance | Examples must run without errors |
| Dependencies | Manage via DESCRIPTION | Version pinning needed | CRAN compatibility checks |

## Integration Points

### GitHub Actions Integration
```yaml
# .github/workflows/R-CMD-check.yaml
name: R-CMD-check
on: [push, pull_request]
jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - {os: ubuntu-latest,   r: 'release'}
          - {os: windows-latest, r: 'release'}
          - {os: macos-latest,   r: 'release'}
    steps:
      - uses: actions/checkout@v3
      - uses: r-lib/actions/setup-r@v2
      - uses: r-lib/actions/setup-r-dependencies@v2
      - uses: r-lib/actions/check-r-package@v2
```

### pkgdown Configuration
```yaml
# _pkgdown.yml
url: https://bfunovits.github.io/RLDM
template:
  params:
    bootswatch: flatly
navbar:
  structure:
    left: [intro, reference, articles, news]
    right: [github]
```

## Migration Strategy

For cleaning up existing architecture:

1. **Audit current structure** - Document what exists vs. what should exist
2. **Create target structure** - Define clean organization based on patterns above
3. **Incremental migration** - Move files in logical groups, testing after each move
4. **Update references** - Fix any broken imports or references
5. **Verify functionality** - Ensure package still works after reorganization

## Sources

**Based on analysis of:**
- Existing RLDM package structure
- R package development best practices
- CRAN package requirements
- Common patterns in successful R packages

**Confidence:** HIGH (architecture patterns are well-established in R ecosystem)